---
title: "Cleaning Case Study 1"
format: html
editor: visual
---

## Case Study 1: Iceland v. Eurozone

```{r, message=F}
library(tidyverse)
library(readr)
library(stringr)
options(scipen = 999)
```

### Cleaning Raw BOP Data

```{r}
case_one_raw <- read_csv("../updated_data/Raw/case_study_1_data_july_24_2025.csv")
```

```{r}
head(case_one_raw)
```

```{r}
case_one_raw |> 
  mutate(
    ENTRY_FIRST_WORD = str_extract(BOP_ACCOUNTING_ENTRY, "^[^,]+"),
    FULL_INDICATOR = paste(ENTRY_FIRST_WORD, INDICATOR, sep = " - ")
  ) |> 
  select(-c(BOP_ACCOUNTING_ENTRY, INDICATOR, ENTRY_FIRST_WORD, FREQUENCY, SCALE)) |> 
  select(COUNTRY, TIME_PERIOD, FULL_INDICATOR, everything()) -> case_one_new_cols
```

```{r}
case_one_new_cols |> 
  head()
```

```{r}
case_one_new_cols |> 
  separate(TIME_PERIOD, into = c("YEAR", "QUARTER"), sep = "-") |> 
  mutate(QUARTER = parse_number(QUARTER)) -> case_one_final_cols
```


```{r}
case_one_final_cols |> 
  head()
```

#### Accessing Metadata

```{r}
unique(case_one_final_cols$COUNTRY)
```

```{r}
unique(case_one_final_cols$FULL_INDICATOR)
```

### Cleaning Raw GDP Data

```{r}
gdp_raw <- read_csv("../updated_data/Raw/gdp_july_24_2025.csv")
```
```{r}
head(gdp_raw)
```

```{r}
gdp_raw |> 
  select(COUNTRY, TIME_PERIOD, INDICATOR, OBS_VALUE) -> gdp_cleaned
```

```{r}
gdp_cleaned |> 
  head()
```


### Pivot Both Datasets Wider

```{r}
case_one_final_cols |> 
  mutate(YEAR = as.double(YEAR)) |> 
  pivot_wider(names_from = FULL_INDICATOR, values_from = OBS_VALUE) -> case_one_pivoted
```


```{r}
gdp_cleaned |> 
  pivot_wider(names_from = INDICATOR, values_from = OBS_VALUE) -> gdp_pivoted
```


### Join Data

```{r}
case_one_pivoted |> 
  left_join(
    gdp_pivoted,
    by = join_by(
      COUNTRY == COUNTRY,
      YEAR == TIME_PERIOD
    )
  ) -> case_one_joined
```

```{r}
head(case_one_joined)
```

```{r}
case_one_joined |> 
  mutate(UNIT = paste0(UNIT, ", Nominal (Current Prices)")) -> case_one_join_clean

```

```{r}
case_one_join_clean |> 
  head()
```

```{r}
colnames(case_one_join_clean)
```


```{r}
case_one_join_clean |> 
  mutate(across(
    .cols = 5:17,
    .fns = ~ (.x*4 / `Gross domestic product (GDP), Current prices, US dollar`) * 100, # Annualized BOP
    .names = "{.col}_PGDP"
  ))  |> 
  select(1:4, ends_with("_PGDP")) |> 
  mutate(UNIT = paste0(UNIT, ", % of GDP")) -> full_case_one_df
```

```{r}
full_case_one_df |> 
  mutate(GROUP = ifelse(COUNTRY == "Iceland", "Iceland", "Eurozone")) |> 
  select(1, GROUP, everything()) -> full_case_one_grouped
```


```{r}
full_case_one_grouped |> 
  head()
```

```{r}
full_case_one_grouped |> write_csv("case_one_grouped.csv")
```

### Analysis

#### Analyze Each Country

```{r}
indicator_cols <- names(full_case_one_grouped)[6:ncol(full_case_one_grouped)]
```

```{r}
country_summary <- full_case_one_grouped |> 
  group_by(COUNTRY) |> 
  summarise(across(
    all_of(indicator_cols),
    list(
      mean = \(x) mean(x, na.rm = TRUE),
      sd = \(x) sd(x, na.rm = TRUE),
      min = \(x) min(x, na.rm = TRUE),
      max = \(x) max(x, na.rm = TRUE)
    )
  ))

```

```{r}
country_summary_long <- country_summary |> 
  pivot_longer(
    cols = -COUNTRY,
    names_to = c("Indicator", "Stat"),
    names_sep = "_(?=mean|sd|min|max)",  # regex to split at "_mean", "_sd", etc.
    values_to = "Value"
  )
```


### Side-by-side Boxplots

#### By Countries

```{r}
full_case_one_grouped |> 
  group_by(COUNTRY) |> 
  summarise(across(
    all_of(indicator_cols),
    list(
      mean = \(x) mean(x, na.rm = TRUE),
      sd   = \(x) sd(x, na.rm = TRUE)
    )
  )) -> country_summary
```

```{r}
country_long <- country_summary |> 
  pivot_longer(-COUNTRY, names_to = c("Indicator", "Stat"), names_sep = "_(?=mean|sd)", values_to = "Value")

ggplot(country_long, aes(x = COUNTRY, y = Value)) +
  geom_boxplot() +
  facet_wrap(~ Stat, scales = "free") +
  labs(title = "Boxplots of Mean and Std Dev per Indicator by Country", y = "% of GDP") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
  
```

#### By Groups: With Luxembourg

```{r}
full_case_one_grouped |> 
  group_by(GROUP) |> 
  summarise(across(
    all_of(indicator_cols),
    list(
      mean = \(x) mean(x, na.rm = TRUE),
      sd   = \(x) sd(x, na.rm = TRUE)
    )
  )) -> group_summary

```


```{r}

group_long <- group_summary |> 
  pivot_longer(-GROUP, names_to = c("Indicator", "Stat"), names_sep = "_(?=mean|sd)", values_to = "Value")

ggplot(group_long, aes(x = GROUP, y = Value)) +
  geom_boxplot() +
  facet_wrap(~ Stat, scales = "free") +
  labs(title = "Boxplots of Mean and Std Dev per Indicator by Group", y = "% of GDP")

```

#### By Groups: Without Luxembourg

```{r}
full_case_one_grouped |> 
  filter(COUNTRY != "Luxembourg") |> 
  group_by(GROUP) |> 
  summarise(across(
    all_of(indicator_cols),
    list(
      mean = \(x) mean(x, na.rm = TRUE),
      sd   = \(x) sd(x, na.rm = TRUE)
    )
  )) -> new_group_summary

```

```{r}
group_long <- new_group_summary |> 
  pivot_longer(-GROUP, names_to = c("Indicator", "Stat"), names_sep = "_(?=mean|sd)", values_to = "Value")

ggplot(group_long, aes(x = GROUP, y = Value)) +
  geom_boxplot() +
  facet_wrap(~ Stat, scales = "free") +
  labs(title = "Boxplots of Mean and Std Dev per Indicator by Group", y = "% of GDP")

```

### Add No Lux Option

```{r}
full_case_one_grouped_no_lux <- full_case_one_grouped |> 
  filter(COUNTRY != "Luxembourg")
```


### Time-Series Analysis: Iceland vs Eurozone

```{r}
# Create a cleaner date variable
full_case_one_grouped_no_lux |> 
  mutate(Date = as.Date(paste(YEAR, (QUARTER - 1) * 3 + 1, "01", sep = "-"))) -> dated_full_case_one_grouped_no_lux
```

```{r}
# Function to create side-by-side comparison plots
create_comparison_plot <- function(data, indicator_name) {
  # Clean indicator name for title
  clean_title <- str_replace_all(indicator_name, "_PGDP$", "") |>
    str_replace_all("_", " ") |>
    str_wrap(width = 50)
  
  ggplot(data, aes(x = Date, y = .data[[indicator_name]], color = GROUP)) +
    geom_line(size = 0.8) +
    scale_color_manual(values = c("Iceland" = "#d62728", "Eurozone" = "#1f77b4")) +
    labs(
      title = clean_title,
      x = "Year",
      y = "% of GDP",
      color = "Group"
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(size = 10, hjust = 0.5),
      legend.position = "bottom"
    ) +
    facet_wrap(~ GROUP, ncol = 2, scales = "free_y")
}
```

#### Individual Indicator Plots

```{r}
# Generate plots for all indicators
for (indicator in indicator_cols) {
  cat("\n\n####", str_replace_all(indicator, "_PGDP$", ""), "\n\n")
  
  p <- create_comparison_plot(dated_full_case_one_grouped_no_lux, indicator)
  print(p)
  
  cat("\n\n")
}
```



```{r}
# Summary statistics table for comparison
create_summary_table <- function(data, indicator_name) {
  data %>%
    filter(GROUP %in% c("Eurozone", "Iceland")) %>%
    group_by(GROUP) %>%
    summarise(
      Mean = mean(.data[[indicator_name]], na.rm = TRUE),
      SD = sd(.data[[indicator_name]], na.rm = TRUE),
      Min = min(.data[[indicator_name]], na.rm = TRUE),
      Max = max(.data[[indicator_name]], na.rm = TRUE),
      .groups = "drop"
    ) %>%
    mutate(across(where(is.numeric), ~round(.x, 2)))
}

# Display summary statistics for each indicator
cat("## Summary Statistics by Indicator\n\n")
for (indicator in indicator_cols) {
  clean_name <- str_replace_all(indicator, "_PGDP$", "")
  cat("**", clean_name, "**\n\n")
  
  summary_tbl <- create_summary_table(dated_full_case_one_grouped_no_lux, indicator)
  print(knitr::kable(summary_tbl, caption = paste("Summary Statistics:", clean_name)))
  
  cat("\n\n")
}
```

#### Sample Cleaning Case One Data

```{r}
case_one_raw
```










