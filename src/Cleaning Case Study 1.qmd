---
title: "Cleaning Case Study 1"
format: html
editor: visual
---

## Case Study 1: Iceland v. Eurozone

```{r, message=F}
library(tidyverse)
library(readr)
library(stringr)
options(scipen = 999)
```

### Cleaning Raw BOP Data

```{r}
case_one_raw <- read_csv("case_study_1_data_july_24_2025.csv")
```

```{r}
head(case_one_raw)
```

```{r}
case_one_raw |> 
  mutate(
    ENTRY_FIRST_WORD = str_extract(BOP_ACCOUNTING_ENTRY, "^[^,]+"),
    FULL_INDICATOR = paste(ENTRY_FIRST_WORD, INDICATOR, sep = " - ")
  ) |> 
  select(-c(BOP_ACCOUNTING_ENTRY, INDICATOR, ENTRY_FIRST_WORD, FREQUENCY)) |> 
  select(COUNTRY, TIME_PERIOD, FULL_INDICATOR, everything()) -> case_one_new_cols
```

```{r}
case_one_new_cols |> 
  head()
```

```{r}
case_one_new_cols |> 
  separate(TIME_PERIOD, into = c("YEAR", "QUARTER"), sep = "-") |> 
  mutate(QUARTER = parse_number(QUARTER)) -> case_one_final_cols
```


```{r}
case_one_final_cols |> 
  head()
```

#### Accessing Metadata

```{r}
unique(case_one_final_cols$COUNTRY)
```

```{r}
unique(case_one_final_cols$FULL_INDICATOR)
```

### Cleaning Raw GDP Data

```{r}
gdp_raw <- read_csv("dataset_2025-07-24T18_28_31.898465539Z_DEFAULT_INTEGRATION_IMF.RES_WEO_6.0.0.csv")
```
```{r}
head(gdp_raw)
```

```{r}
gdp_raw |> 
  select(COUNTRY, TIME_PERIOD, INDICATOR, OBS_VALUE) -> gdp_cleaned
```

```{r}
gdp_cleaned |> 
  head()
```


### Pivot Both Datasets Wider

```{r}
case_one_final_cols |> 
  mutate(YEAR = as.double(YEAR)) |> 
  pivot_wider(names_from = FULL_INDICATOR, values_from = OBS_VALUE) -> case_one_pivoted
```


```{r}
gdp_cleaned |> 
  pivot_wider(names_from = INDICATOR, values_from = OBS_VALUE) -> gdp_pivoted
```


### Join Data

```{r}
case_one_pivoted |> 
  left_join(
    gdp_pivoted,
    by = join_by(
      COUNTRY == COUNTRY,
      YEAR == TIME_PERIOD
    )
  ) -> case_one_joined
```

```{r}
head(case_one_joined)
```

```{r}
case_one_joined |> 
  mutate(UNIT = paste0(UNIT, ", Nominal (Current Prices)")) |> 
  select(-SCALE) -> case_one_join_clean

```

```{r}
case_one_join_clean |> 
  head()
```

```{r}
colnames(case_one_join_clean)
```


```{r}
case_one_join_clean |> 
  mutate(across(
    .cols = 5:17,
    .fns = ~ (.x*4 / `Gross domestic product (GDP), Current prices, US dollar`) * 100, # Annualized BOP
    .names = "{.col}_PGDP"
  ))  |> 
  select(1:4, ends_with("_PGDP")) |> 
  mutate(UNIT = paste0(UNIT, ", % of GDP")) -> full_case_one_df
```

```{r}
full_case_one_df |> 
  mutate(GROUP = ifelse(COUNTRY == "Iceland", "Iceland", "Eurozone")) |> 
  select(1, GROUP, everything()) -> full_case_one_grouped
```


```{r}
full_case_one_grouped |> 
  head()
```

```{r}
full_case_one_grouped |> write_csv("case_one_grouped.csv")
```

```{r}
full_case_one_grouped |> 
  filter(COUNTRY == "Iceland")
```


### Analysis

#### Analyze Each Country

```{r}
country_summary <- full_case_one_grouped |> 
  group_by(COUNTRY) |> 
  summarise(across(
    all_of(indicator_cols),
    list(
      mean = \(x) mean(x, na.rm = TRUE),
      sd = \(x) sd(x, na.rm = TRUE),
      min = \(x) min(x, na.rm = TRUE),
      max = \(x) max(x, na.rm = TRUE)
    )
  ))

```

```{r}
country_summary_long <- country_summary |> 
  pivot_longer(
    cols = -COUNTRY,
    names_to = c("Indicator", "Stat"),
    names_sep = "_(?=mean|sd|min|max)",  # regex to split at "_mean", "_sd", etc.
    values_to = "Value"
  )
```



### Side-by-side Boxplots

#### By Countries

```{r}
indicator_cols <- names(full_case_one_grouped)[6:ncol(full_case_one_grouped)]
```

```{r}
full_case_one_grouped |> 
  group_by(COUNTRY) |> 
  summarise(across(
    all_of(indicator_cols),
    list(
      mean = \(x) mean(x, na.rm = TRUE),
      sd   = \(x) sd(x, na.rm = TRUE)
    )
  )) -> country_summary
```

```{r}
country_long <- country_summary |> 
  pivot_longer(-COUNTRY, names_to = c("Indicator", "Stat"), names_sep = "_(?=mean|sd)", values_to = "Value")

ggplot(country_long, aes(x = COUNTRY, y = Value)) +
  geom_boxplot() +
  facet_wrap(~ Stat, scales = "free") +
  labs(title = "Boxplots of Mean and Std Dev per Indicator by Country", y = "% of GDP") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
  
```

#### By Groups: With Luxembourg

```{r}
full_case_one_grouped |> 
  group_by(GROUP) |> 
  summarise(across(
    all_of(indicator_cols),
    list(
      mean = \(x) mean(x, na.rm = TRUE),
      sd   = \(x) sd(x, na.rm = TRUE)
    )
  )) -> group_summary

```


```{r}

group_long <- group_summary |> 
  pivot_longer(-GROUP, names_to = c("Indicator", "Stat"), names_sep = "_(?=mean|sd)", values_to = "Value")

ggplot(group_long, aes(x = GROUP, y = Value)) +
  geom_boxplot() +
  facet_wrap(~ Stat, scales = "free") +
  labs(title = "Boxplots of Mean and Std Dev per Indicator by Group", y = "% of GDP")

```

#### By Groups: Without Luxembourg

```{r}
full_case_one_grouped |> 
  filter(COUNTRY != "Luxembourg") |> 
  group_by(GROUP) |> 
  summarise(across(
    all_of(indicator_cols),
    list(
      mean = \(x) mean(x, na.rm = TRUE),
      sd   = \(x) sd(x, na.rm = TRUE)
    )
  )) -> new_group_summary

```

```{r}
group_long <- new_group_summary |> 
  pivot_longer(-GROUP, names_to = c("Indicator", "Stat"), names_sep = "_(?=mean|sd)", values_to = "Value")

ggplot(group_long, aes(x = GROUP, y = Value)) +
  geom_boxplot() +
  facet_wrap(~ Stat, scales = "free") +
  labs(title = "Boxplots of Mean and Std Dev per Indicator by Group", y = "% of GDP")

```

### Add No Lux Option

```{r}
full_case_one_grouped_no_lux <- full_case_one_grouped |> 
  filter(COUNTRY != "Luxembourg")
```

```{r}
full_case_one_grouped |> 
  filter(COUNTRY == "Iceland")
```


### Time-Series Plots

```{r}
full_case_one_grouped_no_lux |> 
  mutate(Date = as.Date(paste(YEAR, (QUARTER - 1) * 3 + 1, "01", sep = "-"))) -> dated_full_case_one_grouped_no_lux
```

```{r}
full_case_one_grouped_no_lux |> 
  filter(COUNTRY == "Iceland")
```


```{r}
dated_full_case_one_grouped_no_lux |> 
  filter(COUNTRY == "Iceland") |> 
  ggplot(aes(x = Date, y = `Assets - Portfolio investment, Total financial assets/liabilities_PGDP`)) +
  geom_line()
```

```{r}

plot(dated_full_case_one_grouped_no_lux$Date, dated_full_case_one_grouped_no_lux$`Assets - Other investment, Debt instruments, Deposit taking corporations, except the Central Bank_PGDP`)
```



```{r}

dated_full_case_one_grouped_no_lux |> 
  filter(COUNTRY == "Iceland") |> 
  ggplot(aes(x = Date, y = `Assets - Other investment, Debt instruments, Deposit taking corporations, except the Central Bank_PGDP`)) +
  geom_line() +
  labs(title = "Indicator as % of GDP", x = "Date", y = "% of GDP") +
  theme_minimal()

```



### Summary Stats and Time-Series Plots

```{r}
generate_indicator_report <- function(indicator_name, data) {
  # Filter and reshape
  summary_tbl <- data %>%
    filter(GROUP %in% c("Eurozone", "Iceland")) %>%
    group_by(GROUP) %>%
    summarise(
      Mean = mean(.data[[indicator_name]], na.rm = TRUE),
      SD   = sd(.data[[indicator_name]], na.rm = TRUE),
      Min  = min(.data[[indicator_name]], na.rm = TRUE),
      Max  = max(.data[[indicator_name]], na.rm = TRUE)
    )

  # Create time series plot
  ts_plot <- ggplot(
      data %>% filter(GROUP %in% c("Eurozone", "Iceland")),
      aes(x = YEAR + (QUARTER - 1) / 4, y = .data[[indicator_name]], color = GROUP)
    ) +
    geom_line() +
    labs(
      title = paste("Time Series of", indicator_name),
      x = "Year", y = "% of GDP"
    ) +
    theme_minimal()

  list(summary = summary_tbl, plot = ts_plot)
}

```



```{r}
library(tidyverse)

# Loop over each indicator
for (ind in indicator_cols) {
  cat("\n\n###", ind, "\n\n")

  for (grp in c("Eurozone", "Iceland")) {
    cat("\n**Group:**", grp, "\n")

    # Filter data
    subset <- full_case_one_grouped_no_lux %>%
      filter(GROUP == grp)

    # Compute and print summary statistics
    summary_tbl <- subset %>%
      summarise(
        Mean = mean(.data[[ind]], na.rm = TRUE),
        SD   = sd(.data[[ind]], na.rm = TRUE),
        Min  = min(.data[[ind]], na.rm = TRUE),
        Max  = max(.data[[ind]], na.rm = TRUE)
      )

    print(knitr::kable(summary_tbl, digits = 2))

    # Plot time series
    p <- ggplot(subset, aes(x = YEAR + (QUARTER - 1)/4, y = .data[[ind]])) +
      geom_line(color = ifelse(grp == "Eurozone", "steelblue", "darkred")) +
      labs(
        title = paste(ind, "-", grp),
        x = "Year",
        y = "% of GDP"
      ) +
      theme_minimal()

    print(p)
  }
}

```

```{r}
for (ind in indicator_cols) {
  cat("##", ind, "\n\n")

  # Tables
  table_data <- group_summary_table(full_case_one_grouped_no_lux, ind)
  euro_tbl <- table_data %>% filter(GROUP == "Eurozone")
  iceland_tbl <- table_data %>% filter(GROUP == "Iceland")

  # Display side-by-side tables
  gridExtra::grid.arrange(
    tableGrob(euro_tbl, rows = NULL),
    tableGrob(iceland_tbl, rows = NULL),
    ncol = 2,
    top = textGrob(paste("Summary Stats -", ind), gp = gpar(fontsize = 14, fontface = "bold"))
  )

  # Time series plots
  euro_plot <- plot_group_timeseries(df, ind, "Eurozone")
  iceland_plot <- plot_group_timeseries(df, ind, "Iceland")

  # Display side-by-side plots
  gridExtra::grid.arrange(euro_plot, iceland_plot, ncol = 2)
}

```

### Sample Cleaning Case One Data

```{r}
case_one_raw
```










