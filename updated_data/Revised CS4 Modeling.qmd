---
title: "Revised CS4 Modeling"
format: html
editor: visual
---

## Import Full DF

```{r, message=F}
library(tidyverse)
library(readr)
library(stringr)
options(scipen = 999)
```

```{r}
full_df_usd <- read_csv("Clean/comprehensive_df_USD.csv ")
```
```{r}
full_df_usd |> 
  head()
```

```{r}
full_df_usd |> 
  colnames()
```


### Create Net Flows Column, Rename All Flows, Select Relevant Columns
```{r}
full_df_usd |> 
  mutate(
    net_capital_flows_usd = `Net (net acquisition of financial assets less net incurrence of liabilities) - Direct investment, Total financial assets/liabilities` + `Net (net acquisition of financial assets less net incurrence of liabilities) - Portfolio investment, Total financial assets/liabilities` + `Net (net acquisition of financial assets less net incurrence of liabilities) - Other investment, Total financial assets/liabilities`,
    net_equity_portfolio_investment_usd = `Assets - Portfolio investment, Equity and investment fund shares` - `Liabilities - Portfolio investment, Equity and investment fund shares`,
    net_debt_portfolio_investment_usd = `Assets - Portfolio investment, Debt securities` - `Liabilities - Portfolio investment, Debt securities`,
  ) |> 
  rename(
    net_direct_investment_usd = `Net (net acquisition of financial assets less net incurrence of liabilities) - Direct investment, Total financial assets/liabilities`,
    net_portfolio_investment_usd = `Net (net acquisition of financial assets less net incurrence of liabilities) - Portfolio investment, Total financial assets/liabilities`,
    net_other_investment_usd = `Net (net acquisition of financial assets less net incurrence of liabilities) - Other investment, Total financial assets/liabilities`
  ) |> 
  select(COUNTRY, YEAR, QUARTER, UNIT, `Gross domestic product (GDP), Current prices, US dollar`, net_direct_investment_usd, net_portfolio_investment_usd, net_equity_portfolio_investment_usd, net_debt_portfolio_investment_usd, net_other_investment_usd, net_capital_flows_usd) -> clean_cap_flows_usd
```

```{r}
clean_cap_flows_usd |> 
  head()
```

### Create Groupings for Statistical Tests

#### Establish Country Groups

```{r}
eurozone_countries <- c("Portugal","Ireland","Finland","Netherlands, The",
                        "Belgium","Italy","Spain","Austria","France")
soe_countries <- c("Brunei Darussalam","Bahamas, The","Bermuda","Seychelles",
                   "Aruba, Kingdom of the Netherlands","Mauritius","Malta")
baltics_countries <- c("Estonia, Republic of","Latvia, Republic of","Lithuania, Republic of")

```

#### Clean GDP for Normalization

```{r}
clean_cap_flows_usd |> 
  select(COUNTRY, YEAR, QUARTER, UNIT, `Gross domestic product (GDP), Current prices, US dollar`) |> 
  pivot_wider(names_from = COUNTRY, values_from = `Gross domestic product (GDP), Current prices, US dollar`) |> 
  rowwise() |>
  mutate(
    
    eurozone_gdp = sum(c_across(all_of(eurozone_countries)), na.rm = TRUE),

    soe_gdp = sum(c_across(all_of(soe_countries)), na.rm = TRUE),

    baltics_gdp = sum(c_across(all_of(baltics_countries)), na.rm = TRUE)
  ) |> 
  ungroup() |> 
  select(YEAR, QUARTER, UNIT, Iceland, eurozone_gdp, soe_gdp, baltics_gdp) |> 
  rename(iceland_gdp = Iceland)-> gdp_usd
```

```{r}
gdp_usd |> 
  head()
```

```{r}
ANNUALIZE <- 4

gdp_wide <- clean_cap_flows_usd |>
  select(COUNTRY, YEAR, QUARTER, UNIT,
         gdp_usd = `Gross domestic product (GDP), Current prices, US dollar`) |>
  pivot_wider(names_from = COUNTRY, values_from = gdp_usd)

gdp_wide |> tail()
```

#### Net Direct Investment

```{r}
ndi_wide <- clean_cap_flows_usd |>
  select(COUNTRY, YEAR, QUARTER, UNIT,
         ndi_usd = net_direct_investment_usd) |>
  pivot_wider(names_from = COUNTRY, values_from = ndi_usd)

ndi_wide |> tail()
```

```{r}
ndi_pgdp_full <- ndi_wide |>
  left_join(gdp_wide, by = c("YEAR","QUARTER","UNIT"),
            suffix = c("_ndi", "_gdp")) |>
  rowwise() |>
  mutate(
    iceland_pgdp = (Iceland_ndi * ANNUALIZE / Iceland_gdp) * 100,
    # For Groups:
    # --- Weighted averages (%GDP): sum(flows)/sum(GDP) * ANNUALIZE * 100
    eurozone_pgdp_weighted = {
      ndi_sum <- sum(c_across(all_of(paste0(eurozone_countries, "_ndi"))), na.rm = TRUE)
      gdp_sum <- sum(c_across(all_of(paste0(eurozone_countries, "_gdp"))), na.rm = TRUE)
      if (is.finite(gdp_sum) && gdp_sum > 0) (ndi_sum * ANNUALIZE / gdp_sum) * 100 else NA_real_
    },
    soe_pgdp_weighted = {
      ndi_sum <- sum(c_across(all_of(paste0(soe_countries, "_ndi"))), na.rm = TRUE)
      gdp_sum <- sum(c_across(all_of(paste0(soe_countries, "_gdp"))), na.rm = TRUE)
      if (is.finite(gdp_sum) && gdp_sum > 0) (ndi_sum * ANNUALIZE / gdp_sum) * 100 else NA_real_
    },
    baltics_pgdp_weighted = {
      ndi_sum <- sum(c_across(all_of(paste0(baltics_countries, "_ndi"))), na.rm = TRUE)
      gdp_sum <- sum(c_across(all_of(paste0(baltics_countries, "_gdp"))), na.rm = TRUE)
      if (is.finite(gdp_sum) && gdp_sum > 0) (ndi_sum * ANNUALIZE / gdp_sum) * 100 else NA_real_
    },

    # --- Simple averages (%GDP): mean over countries of (NDI/GDP)*ANNUALIZE*100
    eurozone_pgdp_simple = {
      vals <- (c_across(all_of(paste0(eurozone_countries, "_ndi"))) * ANNUALIZE /
               c_across(all_of(paste0(eurozone_countries, "_gdp")))) * 100
      if (all(is.na(vals))) NA_real_ else mean(vals, na.rm = TRUE)
    },
    soe_pgdp_simple = {
      vals <- (c_across(all_of(paste0(soe_countries, "_ndi"))) * ANNUALIZE /
               c_across(all_of(paste0(soe_countries, "_gdp")))) * 100
      if (all(is.na(vals))) NA_real_ else mean(vals, na.rm = TRUE)
    },
    baltics_pgdp_simple = {
      vals <- (c_across(all_of(paste0(baltics_countries, "_ndi"))) * ANNUALIZE /
               c_across(all_of(paste0(baltics_countries, "_gdp")))) * 100
      if (all(is.na(vals))) NA_real_ else mean(vals, na.rm = TRUE)
    },
    UNIT = "Percentage of Nominal GDP (%)"
  ) |>
  ungroup() |>
  select(YEAR, QUARTER, UNIT,
         iceland_pgdp,
         eurozone_pgdp_weighted, eurozone_pgdp_simple,
         soe_pgdp_weighted,      soe_pgdp_simple,
         baltics_pgdp_weighted,  baltics_pgdp_simple)
```

```{r}
ndi_pgdp_full |> 
  head()
```

```{r}
ndi_pgdp_full |> 
  filter(!YEAR %in% c(2008, 2009, 2010, 2020, 2021, 2022)) -> ndi_pgdp_no_crises
```

```{r}
 ndi_pgdp_no_crises |> 
  distinct(YEAR) |> 
  head(10)
```


#### Net Portfolio Investment

```{r}
npi_wide <- clean_cap_flows_usd |>
  select(COUNTRY, YEAR, QUARTER, UNIT,
         npi_usd = net_portfolio_investment_usd) |>
  pivot_wider(names_from = COUNTRY, values_from = npi_usd)

npi_wide |> tail()
```

```{r}
npi_pgdp_full <- npi_wide |>
  left_join(gdp_wide, by = c("YEAR","QUARTER","UNIT"),
            suffix = c("_npi", "_gdp")) |>
  rowwise() |>
  mutate(
    iceland_pgdp = (Iceland_npi * ANNUALIZE / Iceland_gdp) * 100,
    # For Groups:
    # --- Weighted averages (%GDP): sum(flows)/sum(GDP) * ANNUALIZE * 100
    eurozone_pgdp_weighted = {
      npi_sum <- sum(c_across(all_of(paste0(eurozone_countries, "_npi"))), na.rm = TRUE)
      gdp_sum <- sum(c_across(all_of(paste0(eurozone_countries, "_gdp"))), na.rm = TRUE)
      if (is.finite(gdp_sum) && gdp_sum > 0) (npi_sum * ANNUALIZE / gdp_sum) * 100 else NA_real_
    },
    soe_pgdp_weighted = {
      npi_sum <- sum(c_across(all_of(paste0(soe_countries, "_npi"))), na.rm = TRUE)
      gdp_sum <- sum(c_across(all_of(paste0(soe_countries, "_gdp"))), na.rm = TRUE)
      if (is.finite(gdp_sum) && gdp_sum > 0) (npi_sum * ANNUALIZE / gdp_sum) * 100 else NA_real_
    },
    baltics_pgdp_weighted = {
      npi_sum <- sum(c_across(all_of(paste0(baltics_countries, "_npi"))), na.rm = TRUE)
      gdp_sum <- sum(c_across(all_of(paste0(baltics_countries, "_gdp"))), na.rm = TRUE)
      if (is.finite(gdp_sum) && gdp_sum > 0) (npi_sum * ANNUALIZE / gdp_sum) * 100 else NA_real_
    },

    # --- Simple averages (%GDP): mean over countries of (npi/GDP)*ANNUALIZE*100
    eurozone_pgdp_simple = {
      vals <- (c_across(all_of(paste0(eurozone_countries, "_npi"))) * ANNUALIZE /
               c_across(all_of(paste0(eurozone_countries, "_gdp")))) * 100
      if (all(is.na(vals))) NA_real_ else mean(vals, na.rm = TRUE)
    },
    soe_pgdp_simple = {
      vals <- (c_across(all_of(paste0(soe_countries, "_npi"))) * ANNUALIZE /
               c_across(all_of(paste0(soe_countries, "_gdp")))) * 100
      if (all(is.na(vals))) NA_real_ else mean(vals, na.rm = TRUE)
    },
    baltics_pgdp_simple = {
      vals <- (c_across(all_of(paste0(baltics_countries, "_npi"))) * ANNUALIZE /
               c_across(all_of(paste0(baltics_countries, "_gdp")))) * 100
      if (all(is.na(vals))) NA_real_ else mean(vals, na.rm = TRUE)
    },
    UNIT = "Percentage of Nominal GDP (%)"
  ) |>
  ungroup() |>
  select(YEAR, QUARTER, UNIT,
         iceland_pgdp,
         eurozone_pgdp_weighted, eurozone_pgdp_simple,
         soe_pgdp_weighted,      soe_pgdp_simple,
         baltics_pgdp_weighted,  baltics_pgdp_simple)
```

```{r}
npi_pgdp_full |> 
  head()
```

```{r}
npi_pgdp_full |> 
  filter(!YEAR %in% c(2008, 2009, 2010, 2020, 2021, 2022)) -> npi_pgdp_no_crises
```

##### Equity Portfolio Investment

```{r}
epi_wide <- clean_cap_flows_usd |>
  select(COUNTRY, YEAR, QUARTER, UNIT,
         epi_usd = net_equity_portfolio_investment_usd) |>
  pivot_wider(names_from = COUNTRY, values_from = epi_usd)

epi_wide |> tail()
```

```{r}
epi_pgdp_full <- epi_wide |>
  left_join(gdp_wide, by = c("YEAR","QUARTER","UNIT"),
            suffix = c("_epi", "_gdp")) |>
  rowwise() |>
  mutate(
    iceland_pgdp = (Iceland_epi * ANNUALIZE / Iceland_gdp) * 100,
    # For Groups:
    # --- Weighted averages (%GDP): sum(flows)/sum(GDP) * ANNUALIZE * 100
    eurozone_pgdp_weighted = {
      epi_sum <- sum(c_across(all_of(paste0(eurozone_countries, "_epi"))), na.rm = TRUE)
      gdp_sum <- sum(c_across(all_of(paste0(eurozone_countries, "_gdp"))), na.rm = TRUE)
      if (is.finite(gdp_sum) && gdp_sum > 0) (epi_sum * ANNUALIZE / gdp_sum) * 100 else NA_real_
    },
    soe_pgdp_weighted = {
      epi_sum <- sum(c_across(all_of(paste0(soe_countries, "_epi"))), na.rm = TRUE)
      gdp_sum <- sum(c_across(all_of(paste0(soe_countries, "_gdp"))), na.rm = TRUE)
      if (is.finite(gdp_sum) && gdp_sum > 0) (epi_sum * ANNUALIZE / gdp_sum) * 100 else NA_real_
    },
    baltics_pgdp_weighted = {
      epi_sum <- sum(c_across(all_of(paste0(baltics_countries, "_epi"))), na.rm = TRUE)
      gdp_sum <- sum(c_across(all_of(paste0(baltics_countries, "_gdp"))), na.rm = TRUE)
      if (is.finite(gdp_sum) && gdp_sum > 0) (epi_sum * ANNUALIZE / gdp_sum) * 100 else NA_real_
    },

    # --- Simple averages (%GDP): mean over countries of (epi/GDP)*ANNUALIZE*100
    eurozone_pgdp_simple = {
      vals <- (c_across(all_of(paste0(eurozone_countries, "_epi"))) * ANNUALIZE /
               c_across(all_of(paste0(eurozone_countries, "_gdp")))) * 100
      if (all(is.na(vals))) NA_real_ else mean(vals, na.rm = TRUE)
    },
    soe_pgdp_simple = {
      vals <- (c_across(all_of(paste0(soe_countries, "_epi"))) * ANNUALIZE /
               c_across(all_of(paste0(soe_countries, "_gdp")))) * 100
      if (all(is.na(vals))) NA_real_ else mean(vals, na.rm = TRUE)
    },
    baltics_pgdp_simple = {
      vals <- (c_across(all_of(paste0(baltics_countries, "_epi"))) * ANNUALIZE /
               c_across(all_of(paste0(baltics_countries, "_gdp")))) * 100
      if (all(is.na(vals))) NA_real_ else mean(vals, na.rm = TRUE)
    },
    UNIT = "Percentage of Nominal GDP (%)"
  ) |>
  ungroup() |>
  select(YEAR, QUARTER, UNIT,
         iceland_pgdp,
         eurozone_pgdp_weighted, eurozone_pgdp_simple,
         soe_pgdp_weighted,      soe_pgdp_simple,
         baltics_pgdp_weighted,  baltics_pgdp_simple)
```

```{r}
epi_pgdp_full |> 
  head()
```

```{r}
epi_pgdp_full |> 
  filter(!YEAR %in% c(2008, 2009, 2010, 2020, 2021, 2022)) -> epi_pgdp_no_crises
```

##### Debt Portfolio Investment

```{r}
dpi_wide <- clean_cap_flows_usd |>
  select(COUNTRY, YEAR, QUARTER, UNIT,
         dpi_usd = net_debt_portfolio_investment_usd) |>
  pivot_wider(names_from = COUNTRY, values_from = dpi_usd)

dpi_wide |> tail()
```

```{r}
dpi_pgdp_full <- dpi_wide |>
  left_join(gdp_wide, by = c("YEAR","QUARTER","UNIT"),
            suffix = c("_dpi", "_gdp")) |>
  rowwise() |>
  mutate(
    iceland_pgdp = (Iceland_dpi * ANNUALIZE / Iceland_gdp) * 100,
    # For Groups:
    # --- Weighted averages (%GDP): sum(flows)/sum(GDP) * ANNUALIZE * 100
    eurozone_pgdp_weighted = {
      dpi_sum <- sum(c_across(all_of(paste0(eurozone_countries, "_dpi"))), na.rm = TRUE)
      gdp_sum <- sum(c_across(all_of(paste0(eurozone_countries, "_gdp"))), na.rm = TRUE)
      if (is.finite(gdp_sum) && gdp_sum > 0) (dpi_sum * ANNUALIZE / gdp_sum) * 100 else NA_real_
    },
    soe_pgdp_weighted = {
      dpi_sum <- sum(c_across(all_of(paste0(soe_countries, "_dpi"))), na.rm = TRUE)
      gdp_sum <- sum(c_across(all_of(paste0(soe_countries, "_gdp"))), na.rm = TRUE)
      if (is.finite(gdp_sum) && gdp_sum > 0) (dpi_sum * ANNUALIZE / gdp_sum) * 100 else NA_real_
    },
    baltics_pgdp_weighted = {
      dpi_sum <- sum(c_across(all_of(paste0(baltics_countries, "_dpi"))), na.rm = TRUE)
      gdp_sum <- sum(c_across(all_of(paste0(baltics_countries, "_gdp"))), na.rm = TRUE)
      if (is.finite(gdp_sum) && gdp_sum > 0) (dpi_sum * ANNUALIZE / gdp_sum) * 100 else NA_real_
    },

    # --- Simple averages (%GDP): mean over countries of (dpi/GDP)*ANNUALIZE*100
    eurozone_pgdp_simple = {
      vals <- (c_across(all_of(paste0(eurozone_countries, "_dpi"))) * ANNUALIZE /
               c_across(all_of(paste0(eurozone_countries, "_gdp")))) * 100
      if (all(is.na(vals))) NA_real_ else mean(vals, na.rm = TRUE)
    },
    soe_pgdp_simple = {
      vals <- (c_across(all_of(paste0(soe_countries, "_dpi"))) * ANNUALIZE /
               c_across(all_of(paste0(soe_countries, "_gdp")))) * 100
      if (all(is.na(vals))) NA_real_ else mean(vals, na.rm = TRUE)
    },
    baltics_pgdp_simple = {
      vals <- (c_across(all_of(paste0(baltics_countries, "_dpi"))) * ANNUALIZE /
               c_across(all_of(paste0(baltics_countries, "_gdp")))) * 100
      if (all(is.na(vals))) NA_real_ else mean(vals, na.rm = TRUE)
    },
    UNIT = "Percentage of Nominal GDP (%)"
  ) |>
  ungroup() |>
  select(YEAR, QUARTER, UNIT,
         iceland_pgdp,
         eurozone_pgdp_weighted, eurozone_pgdp_simple,
         soe_pgdp_weighted,      soe_pgdp_simple,
         baltics_pgdp_weighted,  baltics_pgdp_simple)
```

```{r}
dpi_pgdp_full |> 
  head()
```

```{r}
dpi_pgdp_full |> 
  filter(!YEAR %in% c(2008, 2009, 2010, 2020, 2021, 2022)) -> dpi_pgdp_no_crises
```

#### Net Other Investment

```{r}
noi_wide <- clean_cap_flows_usd |>
  select(COUNTRY, YEAR, QUARTER, UNIT,
         noi_usd = net_other_investment_usd) |>
  pivot_wider(names_from = COUNTRY, values_from = noi_usd)

noi_wide |> tail()
```

```{r}
noi_pgdp_full <- noi_wide |>
  left_join(gdp_wide, by = c("YEAR","QUARTER","UNIT"),
            suffix = c("_noi", "_gdp")) |>
  rowwise() |>
  mutate(
    iceland_pgdp = (Iceland_noi * ANNUALIZE / Iceland_gdp) * 100,
    # For Groups:
    # --- Weighted averages (%GDP): sum(flows)/sum(GDP) * ANNUALIZE * 100
    eurozone_pgdp_weighted = {
      noi_sum <- sum(c_across(all_of(paste0(eurozone_countries, "_noi"))), na.rm = TRUE)
      gdp_sum <- sum(c_across(all_of(paste0(eurozone_countries, "_gdp"))), na.rm = TRUE)
      if (is.finite(gdp_sum) && gdp_sum > 0) (noi_sum * ANNUALIZE / gdp_sum) * 100 else NA_real_
    },
    soe_pgdp_weighted = {
      noi_sum <- sum(c_across(all_of(paste0(soe_countries, "_noi"))), na.rm = TRUE)
      gdp_sum <- sum(c_across(all_of(paste0(soe_countries, "_gdp"))), na.rm = TRUE)
      if (is.finite(gdp_sum) && gdp_sum > 0) (noi_sum * ANNUALIZE / gdp_sum) * 100 else NA_real_
    },
    baltics_pgdp_weighted = {
      noi_sum <- sum(c_across(all_of(paste0(baltics_countries, "_noi"))), na.rm = TRUE)
      gdp_sum <- sum(c_across(all_of(paste0(baltics_countries, "_gdp"))), na.rm = TRUE)
      if (is.finite(gdp_sum) && gdp_sum > 0) (noi_sum * ANNUALIZE / gdp_sum) * 100 else NA_real_
    },

    # --- Simple averages (%GDP): mean over countries of (noi/GDP)*ANNUALIZE*100
    eurozone_pgdp_simple = {
      vals <- (c_across(all_of(paste0(eurozone_countries, "_noi"))) * ANNUALIZE /
               c_across(all_of(paste0(eurozone_countries, "_gdp")))) * 100
      if (all(is.na(vals))) NA_real_ else mean(vals, na.rm = TRUE)
    },
    soe_pgdp_simple = {
      vals <- (c_across(all_of(paste0(soe_countries, "_noi"))) * ANNUALIZE /
               c_across(all_of(paste0(soe_countries, "_gdp")))) * 100
      if (all(is.na(vals))) NA_real_ else mean(vals, na.rm = TRUE)
    },
    baltics_pgdp_simple = {
      vals <- (c_across(all_of(paste0(baltics_countries, "_noi"))) * ANNUALIZE /
               c_across(all_of(paste0(baltics_countries, "_gdp")))) * 100
      if (all(is.na(vals))) NA_real_ else mean(vals, na.rm = TRUE)
    },
    UNIT = "Percentage of Nominal GDP (%)"
  ) |>
  ungroup() |>
  select(YEAR, QUARTER, UNIT,
         iceland_pgdp,
         eurozone_pgdp_weighted, eurozone_pgdp_simple,
         soe_pgdp_weighted,      soe_pgdp_simple,
         baltics_pgdp_weighted,  baltics_pgdp_simple)
```

```{r}
noi_pgdp_full |> 
  head()
```

```{r}
noi_pgdp_full |> 
  filter(!YEAR %in% c(2008, 2009, 2010, 2020, 2021, 2022)) -> noi_pgdp_no_crises
```

#### Net Flows

```{r}
net_flows_wide <- clean_cap_flows_usd |>
  select(COUNTRY, YEAR, QUARTER, UNIT,
         net_flows_usd = net_capital_flows_usd) |>
  pivot_wider(names_from = COUNTRY, values_from = net_flows_usd)

net_flows_wide |> tail()
```

```{r}
net_flows_pgdp_full <- net_flows_wide |>
  left_join(gdp_wide, by = c("YEAR","QUARTER","UNIT"),
            suffix = c("_net_flows", "_gdp")) |>
  rowwise() |>
  mutate(
    iceland_pgdp = (Iceland_net_flows * ANNUALIZE / Iceland_gdp) * 100,
    # For Groups:
    # --- Weighted averages (%GDP): sum(flows)/sum(GDP) * ANNUALIZE * 100
    eurozone_pgdp_weighted = {
      net_flows_sum <- sum(c_across(all_of(paste0(eurozone_countries, "_net_flows"))), na.rm = TRUE)
      gdp_sum <- sum(c_across(all_of(paste0(eurozone_countries, "_gdp"))), na.rm = TRUE)
      if (is.finite(gdp_sum) && gdp_sum > 0) (net_flows_sum * ANNUALIZE / gdp_sum) * 100 else NA_real_
    },
    soe_pgdp_weighted = {
      net_flows_sum <- sum(c_across(all_of(paste0(soe_countries, "_net_flows"))), na.rm = TRUE)
      gdp_sum <- sum(c_across(all_of(paste0(soe_countries, "_gdp"))), na.rm = TRUE)
      if (is.finite(gdp_sum) && gdp_sum > 0) (net_flows_sum * ANNUALIZE / gdp_sum) * 100 else NA_real_
    },
    baltics_pgdp_weighted = {
      net_flows_sum <- sum(c_across(all_of(paste0(baltics_countries, "_net_flows"))), na.rm = TRUE)
      gdp_sum <- sum(c_across(all_of(paste0(baltics_countries, "_gdp"))), na.rm = TRUE)
      if (is.finite(gdp_sum) && gdp_sum > 0) (net_flows_sum * ANNUALIZE / gdp_sum) * 100 else NA_real_
    },

    # --- Simple averages (%GDP): mean over countries of (net_flows/GDP)*ANNUALIZE*100
    eurozone_pgdp_simple = {
      vals <- (c_across(all_of(paste0(eurozone_countries, "_net_flows"))) * ANNUALIZE /
               c_across(all_of(paste0(eurozone_countries, "_gdp")))) * 100
      if (all(is.na(vals))) NA_real_ else mean(vals, na.rm = TRUE)
    },
    soe_pgdp_simple = {
      vals <- (c_across(all_of(paste0(soe_countries, "_net_flows"))) * ANNUALIZE /
               c_across(all_of(paste0(soe_countries, "_gdp")))) * 100
      if (all(is.na(vals))) NA_real_ else mean(vals, na.rm = TRUE)
    },
    baltics_pgdp_simple = {
      vals <- (c_across(all_of(paste0(baltics_countries, "_net_flows"))) * ANNUALIZE /
               c_across(all_of(paste0(baltics_countries, "_gdp")))) * 100
      if (all(is.na(vals))) NA_real_ else mean(vals, na.rm = TRUE)
    },
    UNIT = "Percentage of Nominal GDP (%)"
  ) |>
  ungroup() |>
  select(YEAR, QUARTER, UNIT,
         iceland_pgdp,
         eurozone_pgdp_weighted, eurozone_pgdp_simple,
         soe_pgdp_weighted,      soe_pgdp_simple,
         baltics_pgdp_weighted,  baltics_pgdp_simple)
```

```{r}
net_flows_pgdp_full |> 
  head()
```

```{r}
net_flows_pgdp_full |> 
  filter(!YEAR %in% c(2008, 2009, 2010, 2020, 2021, 2022)) -> net_flows_pgdp_no_crises
```

#### Write DFs

```{r}
write_csv(ndi_pgdp_full, "Clean/CS4_Statistical_Modeling/net_direct_investment_full.csv")
```

```{r}
write_csv(ndi_pgdp_no_crises, "Clean/CS4_Statistical_Modeling/net_direct_investment_no_crises.csv")
```

```{r}
write_csv(npi_pgdp_full, "Clean/CS4_Statistical_Modeling/net_portfolio_investment_full.csv")
```

```{r}
write_csv(npi_pgdp_no_crises, "Clean/CS4_Statistical_Modeling/net_portfolio_investment_no_crises.csv")
```

```{r}
write_csv(epi_pgdp_full, "Clean/CS4_Statistical_Modeling/net_equity_portfolio_investment_full.csv")
```

```{r}
write_csv(epi_pgdp_no_crises, "Clean/CS4_Statistical_Modeling/net_equity_portfolio_investment_no_crises.csv")
```

```{r}
write_csv(dpi_pgdp_full, "Clean/CS4_Statistical_Modeling/net_debt_portfolio_investment_full.csv")
```

```{r}
write_csv(dpi_pgdp_full, "Clean/CS4_Statistical_Modeling/net_debt_portfolio_investment_no_crises.csv")
```

```{r}
write_csv(noi_pgdp_full, "Clean/CS4_Statistical_Modeling/net_other_investment_full.csv")
```

```{r}
write_csv(noi_pgdp_no_crises, "Clean/CS4_Statistical_Modeling/net_other_investment_no_crises.csv")
```

```{r}
write_csv(net_flows_pgdp_full, "Clean/CS4_Statistical_Modeling/net_capital_flows_full.csv")
```

```{r}
write_csv(net_flows_pgdp_no_crises, "Clean/CS4_Statistical_Modeling/net_capital_flows_no_crises.csv")
```




