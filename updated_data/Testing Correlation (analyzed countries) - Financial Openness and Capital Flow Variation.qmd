---
title: "Testing Correlation (no underdeveloped economies) - Financial Openness and Capital Flow Variation"
format: html
editor: visual
---

#### Financial Openness and Net Flows data

### Load libraries

```{r, message=F}
library(tidyverse)
library(readr)
library(stringr)
options(scipen = 999)
```

### IMF Data

##### Loading

```{r}
net_flows_data_USD <- read_csv("Clean/net_flows_data_USD.csv")
```

```{r}
net_flows_data_USD |> head()
```

##### Filter by Countries included in Analysis

```{r}
eurozone_countries <- c("Portugal","Ireland","Finland","Netherlands, The",
                        "Belgium","Italy","Spain","Austria","France")
soe_countries <- c("Brunei Darussalam","Bahamas, The","Bermuda","Seychelles",
                   "Aruba, Kingdom of the Netherlands","Mauritius","Malta")
baltics_countries <- c("Estonia, Republic of","Latvia, Republic of","Lithuania, Republic of")
iceland <- "Iceland"
```

```{r}
net_flows_data_USD |> 
  filter(COUNTRY %in% c(eurozone_countries, soe_countries, baltics_countries, iceland)) -> net_flows_data_filtered_usd
```



##### GDP Standardization and Cleaning

```{r}
gdp_data_USD <- read_csv("Clean/gdp_data_USD.csv")
```

```{r}
gdp_data_USD |> 
  head()
```

```{r}
gdp_data_USD |> 
  distinct(COUNTRY) |> 
  count()
```

```{r}
net_flows_data_filtered_usd |>
  left_join(gdp_data_USD, by = c("COUNTRY", "YEAR" = "TIME_PERIOD")) |>
  mutate(
    net_capital_flows_usd =
      `Net (net acquisition of financial assets less net incurrence of liabilities) - Direct investment, Total financial assets/liabilities` +
      `Net (net acquisition of financial assets less net incurrence of liabilities) - Portfolio investment, Total financial assets/liabilities` +
      `Net (net acquisition of financial assets less net incurrence of liabilities) - Other investment, Total financial assets/liabilities`
  ) |>
  select(COUNTRY, YEAR, `Gross domestic product (GDP), Current prices, US dollar`, net_capital_flows_usd) |>
  mutate(net_flows_pgdp = (net_capital_flows_usd * 4 / `Gross domestic product (GDP), Current prices, US dollar`) * 100) |>
  select(-net_capital_flows_usd, -`Gross domestic product (GDP), Current prices, US dollar`) -> clean_net_flows_pgdp

```

```{r}
clean_net_flows_pgdp |> head()
```

```{r}
clean_net_flows_pgdp |> 
  distinct(COUNTRY) |> 
  count()
```


### Financial Openness Data

##### Loading

```{r}
capital_controls <- read_csv("Other Data (Not IMF)/capital_controls_indicator/cleaned_capital_controls.csv")
```

```{r}
capital_controls |> head()
```

##### Cleaning

```{r}
capital_controls |> 
  select(country, year, overall_restrictions_index) |> 
  rename(COUNTRY = country, YEAR = year) -> clean_capital_controls
```

```{r}
clean_capital_controls |> 
  head()
```

###### Clean Country Columns for Join

```{r}
clean_net_flows_pgdp |> 
  dim()
```

```{r}
clean_capital_controls |> 
  dim()
```

###### Join Country Columns by ISO3c Codes

```{r}
library(dplyr)
library(stringr)
library(countrycode)

normalize_country <- function(x) {
  x |>
    str_squish() |>
    str_replace_all("[[:punct:]]", "") |>
    str_to_title()
}
```

```{r}
clean_net_flows_pgdp |>
  mutate(country_clean = normalize_country(COUNTRY),
         iso3c = countrycode(country_clean, origin = "country.name", destination = "iso3c")) -> clean_net_flows_iso
```

```{r}
clean_capital_controls |>
  mutate(country_clean = normalize_country(COUNTRY),
         iso3c = countrycode(country_clean, origin = "country.name", destination = "iso3c")) -> clean_capital_controls_iso
```

### Join data

##### Create DF with Yearly SDs

```{r}
clean_net_flows_iso |> 
  inner_join(clean_capital_controls_iso, by = c("iso3c", "YEAR")) |> 
  select(!c("COUNTRY.x", "country_clean.x", "COUNTRY.y", "country_clean.y")) |> 
  select(iso3c, everything()) |> 
  group_by(iso3c, YEAR) |> 
  summarise(
    yearly_sd_net_capital_flows_pgdp = sd(net_flows_pgdp, na.rm = TRUE),
    mean_overall_restrictions_index = mean(overall_restrictions_index, na.rm = TRUE),
    .groups = "drop"
  ) |> 
  drop_na() -> yearly_sd_flows_cap_controls
```

```{r}
yearly_sd_flows_cap_controls |> head()
```

##### Create DF with Country Aggregate SDs

```{r}
clean_net_flows_iso |> 
  inner_join(clean_capital_controls_iso, by = c("iso3c", "YEAR")) |> 
  select(!c("COUNTRY.x", "country_clean.x", "COUNTRY.y", "country_clean.y")) |> 
  select(iso3c, everything()) |> 
  group_by(iso3c) |> 
  summarise(
    country_sd_net_capital_flows_pgdp = sd(net_flows_pgdp, na.rm = TRUE),
    mean_overall_restrictions_index = mean(overall_restrictions_index, na.rm = TRUE),
    .groups = "drop"
  ) |> 
  drop_na() -> country_sd_flows_cap_controls
```

```{r}
country_sd_flows_cap_controls |> head()
```

```{r}
country_sd_flows_cap_controls |> 
  distinct(iso3c) |> 
  count()
```

### Run Correlation Analysis

##### Yearly SDs

```{r}
cor.test(yearly_sd_flows_cap_controls$yearly_sd_net_capital_flows_pgdp, yearly_sd_flows_cap_controls$mean_overall_restrictions_index)
```

##### Country Aggregate SDs

```{r}
cor.test(country_sd_flows_cap_controls$country_sd_net_capital_flows_pgdp, country_sd_flows_cap_controls$mean_overall_restrictions_index)
```

### Plot Results

```{r, message=F}
library(ggplot2)
library(dplyr)

# Helper function
make_scatter_with_caption <- function(df, xcol, ycol, title) {
  ct <- cor.test(df[[xcol]], df[[ycol]])
  cor_val <- round(unname(ct$estimate), 2)
  p_val <- ifelse(ct$p.value < 0.001, "< 0.001", signif(ct$p.value, 3))
  
  df <- df %>%
    mutate(
      is_iceland = toupper(trimws(iso3c)) == "ISL",
      legend_lab = ifelse(is_iceland, "Iceland", "Other countries")
    )
  
  ggplot(df, aes(x = .data[[xcol]], y = .data[[ycol]])) +
    geom_point(aes(shape = legend_lab, color = legend_lab), size = 2) +
    geom_smooth(method = "lm", se = FALSE, linetype = "dashed", color = "grey30") +
    scale_shape_manual(values = c("Other countries" = 16, "Iceland" = 17)) +
    scale_color_manual(values = c("Other countries" = "black", "Iceland" = "red")) +
    labs(
      x = "Standard Deviation of Net Capital Flows (% GDP)",
      y = "Mean Overall Restrictions Index",
      title = title,
      subtitle = "Eurozone, Small Open Economies, Baltics, and Iceland",
      caption = paste0("  Cor = ", cor_val, " (p ", p_val, ")"),
      shape = NULL,
      color = NULL
    ) +
    theme_minimal()
}
```

```{r, message=F}
make_scatter_with_caption(
  yearly_sd_flows_cap_controls,
  xcol   = "yearly_sd_net_capital_flows_pgdp",
  ycol   = "mean_overall_restrictions_index",
  title  = "Yearly SD of Net Capital Flows vs. Restrictions Index"
)
```

```{r, message=F}
make_scatter_with_caption(
  country_sd_flows_cap_controls,
  xcol   = "country_sd_net_capital_flows_pgdp",
  ycol   = "mean_overall_restrictions_index",
  title  = "Country SD of Net Capital Flows vs. Restrictions Index"
)
```





